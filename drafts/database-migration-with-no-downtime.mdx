---
title: "Migration of data and database schema with no downtime"
date: "2021-03-05"
description: "How can we make changes to database schema and migrate data without any downtime in the server?"
tags: ['database', 'deployment']
---

## Schema changes

#### Backward compatibility
To achieve no downtime, we must deploy the database schema changes when the system is still live and we should deploy database schema changes before deploying the new version of the backend service. The reason is that if we deploy the new version of the backend service first, the APIs that require the new database schema changes will be broken since the new database schema changes are not there yet.

Therefore, the new version of the database schema should be deployed first and it must be compatible with the existing version of the API in the production environment when the new API version is still not deployed, which means we cannot simply remove or rename any existing tables and columns or change the column data types. We can only do those changes (delete or alter tables, columns, etc) only when we are sure that the tables or the table columns are not referenced anywhere anymore in the backend service.

## Data migration

Data migration maybe required for different reasons such as infrastructure changes or business logic changes. To achieve no downtime during data migration, we need to handle it in the API codes level. 

#### Example

As an example, assume that there is an existing backend service, which is reading and writing data from a database table A. A web application is making requests to the backend service.

A new business requirement comes and requires the data to be structured in a different way so a new table B is created to meet the requirement of the new data model. A data migration script is written to transform the data in table A into the new structure and store the transformed data in the new Table B. Both the backend service and the web application also need to be updated to implement the new business logic.

How to implement the API in the backend services and perform the deployment in such a way that we can achieve no downtime?

First of all, we need to understand:
- The web application will continue to make requests to the backend service when we are migrating the data
- The deployment of the database schema, backend service and the web application cannot be completely schronized and there will small gaps in between.
- Data transactions can happen during the deployment of the new backend service and during the data migration.

To handle the problem mentioned above, we need to make the following changes in the backend services:
- We need to update the existing API in the backend service that writes to the Table A so that the existing API can write to both Table A and the new Table B at the same time.
- New APIs that implement the new business logic and perform read / write in the new table B.
