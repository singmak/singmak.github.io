{"componentChunkName":"component---src-pages-post-mdx-slug-tsx","path":"/post/2021-5-16-sqs-fifo-lambda/","result":{"data":{"mdx":{"frontmatter":{"title":"AWS CDK Example: Process ordered events with AWS Lambda, SQS FIFO and SNS FIFO","date":"May 16, 2021","description":"How to create a AWS Lambda function with AWS CDK"},"body":"var _excluded = [\"components\"];\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"title\": \"AWS CDK Example: Process ordered events with AWS Lambda, SQS FIFO and SNS FIFO\",\n  \"date\": \"2021-05-16\",\n  \"description\": \"How to create a AWS Lambda function with AWS CDK\",\n  \"tags\": [\"aws\", \"lambda\", \"aws-cdk\", \"sqs-fifo\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"There are many cases in that services need to react based on the events published by another service. And in some cases, the order of the processing of the messages is important. For example, think about bank transactions, the deposit, transfer, withdrawal events need to be processed in order or there may not be enough money in the bank account to withdraw or transfer the money. In this tutorial, I am going to demonstrate how to implement an infrastructure that can handles events produced by one system and consumed by another system in order with AWS CDK, AWS Lambda, Amazon SQS FIFO queues, and Amazon SNS FIFO.\"), mdx(\"h2\", null, \"Prerequisite\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"AWS CLI environment \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html\"\n  }, \"setup\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Node.js version 12+\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Basic knowledge of typescript\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Basic knowledge of AWS Lambda\")), mdx(\"h2\", null, \"Setting up the project\"), mdx(\"h3\", null, \"Install AWS CDK\"), mdx(\"p\", null, \"If you have not installed AWS CDK, you can install it by:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"npm install aws-cdk\\ncdk --version\\n\")), mdx(\"p\", null, \"If you have installed it already, you should update it to the latest version by\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"npm i -g aws-cdk@latest\\n\")), mdx(\"h3\", null, \"Init the AWS CDK Project\"), mdx(\"p\", null, \"Now create a new folder for your project and initialize it as a Typescript AWS CDK project.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"mkdir my-ordered-message-process-service\\ncd my-ordered-message-process-service\\ncdk init app --language typescript\\n\")), mdx(\"h3\", null, \"Install dependencies\"), mdx(\"p\", null, \"Install the depencies required for creating the stacks. List of available AWS CDK packages can be found \", \"[here]\", \" (\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.npmjs.com/~aws-cdk-team\"\n  }, \"https://www.npmjs.com/~aws-cdk-team\"), \")\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"npm i aws-sdk @aws-cdk/aws-sns @aws-cdk/aws-lambda @aws-cdk/aws-apigateway @aws-cdk/aws-sqs \\\\\\n@aws-cdk/aws-sns-subscriptions @aws-cdk/aws-lambda-event-sources\\nnpm i -D @types/aws-lambda\\n\")), mdx(\"p\", null, \"Make sure that all AWS CDK modules are in the same versions or there would be issues in building the project.\\nIf not, you need to update the version in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"package.json\"), \" and run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"npm i\"), \" again.\"), mdx(\"h3\", null, \"The stack\"), mdx(\"p\", null, \"After the project is initialized by \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"cdk init app\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"lib/my-ordered-message-process-service-stack.ts\"), \" should look like this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-typescript\"\n  }, \"import * as cdk from '@aws-cdk/core';\\n\\nexport class MyOrderedMessageProcessServiceStack extends cdk.Stack {\\n  constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {\\n    super(scope, id, props);\\n    // The code that defines your stack goes here\\n  }\\n}\\n\")), mdx(\"h3\", null, \"Update the stack to provision all the resources\"), mdx(\"p\", null, \"Now update \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"lib/my-ordered-message-process-service-stack.ts\"), \" to be like this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-typescript\"\n  }, \"import * as cdk from '@aws-cdk/core';\\nimport * as sns from '@aws-cdk/aws-sns';\\nimport * as lambda from '@aws-cdk/aws-lambda';\\nimport * as apigateway from '@aws-cdk/aws-apigateway';\\nimport * as sqs from '@aws-cdk/aws-sqs';\\nimport * as snsSubscriptions from '@aws-cdk/aws-sns-subscriptions';\\nimport * as lambdaEventSources from '@aws-cdk/aws-lambda-event-sources';\\nimport { Duration } from '@aws-cdk/core';\\nexport class MyOrderedMessageProcessServiceStack extends cdk.Stack {\\n  constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {\\n    super(scope, id, props);\\n\\n    const eventMessageTopic = new sns.Topic(this, 'EventMessageTopic', {\\n      topicName: 'eventMessages',\\n      fifo: true,\\n      contentBasedDeduplication: true,\\n    });\\n\\n    // This is optional, you can also publish messages to the SNS topic in any other ways.\\n    // The Lambda code is set to load from `./lambda/handler.js` (will be generated by `npm run build`)\\n    // `EVENT_MESSAGE_TOPIC_ARN` is passed into environment variable so that the function can access it\\n    const publishEventLambda = new lambda.Function(this, 'PublishEventMessage', {\\n      runtime: lambda.Runtime.NODEJS_14_X,\\n      code: lambda.Code.fromAsset(\\\"./lambda\\\"),\\n      handler: \\\"handler.publishMessage\\\",\\n      environment: {\\n        EVENT_MESSAGE_TOPIC_ARN: eventMessageTopic.topicArn,\\n      }\\n    });\\n\\n    // grant the lambda permission to publish message to the SNS topic\\n    eventMessageTopic.grantPublish(publishEventLambda);\\n\\n    // Create the Rest API\\n    const api = new apigateway.RestApi(this, \\\"MessageApi\\\", {\\n      restApiName: \\\"messageApi\\\",\\n      description: \\\"API for publishing messages.\\\"\\n    });\\n    // Add the path /users in the API\\n    const apiResource = api.root.addResource(\\\"messages\\\");\\n    const getIntegration = new apigateway.LambdaIntegration(publishEventLambda);\\n    apiResource.addMethod(\\\"POST\\\", getIntegration);\\n\\n    // create SQS FIFO queue\\n    const processMessageQueue = new sqs.Queue(this, 'ProcessMessage', {\\n      queueName: 'processMessage.fifo',\\n      fifo: true,\\n    });\\n\\n    // subscribe to the SNS queue\\n    eventMessageTopic.addSubscription(new snsSubscriptions.SqsSubscription(processMessageQueue));\\n\\n    // create the Lambda function and subscribe\\n    const processEventLambda = new lambda.Function(this, 'ProcessEvent', {\\n      runtime: lambda.Runtime.NODEJS_14_X,\\n      code: lambda.Code.fromAsset(\\\"./lambda\\\"),\\n      handler: \\\"handler.processMessage\\\",\\n      timeout: Duration.seconds(10), // need to be smaller than the visibilityTimeout of the SQS queue\\n    });\\n    processEventLambda.addEventSource(new lambdaEventSources.SqsEventSource(processMessageQueue, {\\n      batchSize: 2\\n    }));\\n  }\\n}\\n\")), mdx(\"h3\", null, \"Create the handlers for the Lambda functions\"), mdx(\"p\", null, \"Create a new folder \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"lambda\"), \" in the project folder and create a new file \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"handler.ts\"), \"\\nPut the codes below in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"./lambda/handler.ts\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-typescript\"\n  }, \"import * as AWS from 'aws-sdk';\\nimport { APIGatewayEvent, APIGatewayProxyResult, SQSEvent } from 'aws-lambda';\\n\\n// this is passed from the CDK stack\\nconst { EVENT_MESSAGE_TOPIC_ARN } = process.env;\\n\\nconst sns = new AWS.SNS();\\n\\nexport const publishMessage = async (event: APIGatewayEvent): Promise<APIGatewayProxyResult> => {\\n  try {\\n    const { body } = event;\\n    if (!body) throw new Error('no body');\\n    const eventMessages = JSON.parse(body);\\n    console.log(event);\\n    for (const eventMessage of eventMessages) {\\n        const { groupId, message } = eventMessage;\\n        const response = await sns.publish({\\n            TopicArn: EVENT_MESSAGE_TOPIC_ARN,\\n            Message: message,\\n            MessageGroupId: groupId,\\n        }).promise();\\n        console.log(response);\\n    }\\n    return {\\n      statusCode: 200,\\n      body: eventMessages.length,\\n    };\\n  } catch (e) {\\n    return {\\n      statusCode: 500,\\n      body: JSON.stringify(e),\\n    }\\n  }\\n}\\n\\nexport const processMessage = async (event: SQSEvent) => {\\n  console.log('process message start', new Date().toISOString());\\n  for (const record of event.Records) {\\n    console.log(`process message... ${record.body}`);\\n    await new Promise((resolve) => setTimeout(resolve, 3000)); // similate that it takes 3 secs to process the message\\n  }\\n  console.log('process message end', new Date().toISOString());\\n};\\n\")), mdx(\"h2\", null, \"Build and deploy the stack!!!\"), mdx(\"p\", null, \"First you need to build the lambda handler functions\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"npm run build\\n\")), mdx(\"p\", null, \"Bootstrap the AWS CDK app to provision resources the AWS CDK needs to perform the deployment. For example, AWS CDK may need to have an S3 bucket to store assets that will be used during the deployment of the stack. \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.aws.amazon.com/cdk/latest/guide/bootstrapping.html\"\n  }, \"Learn more\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"cdk bootstrap\\n\")), mdx(\"p\", null, \"Deploy the AWS CDK app\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"cdk deploy\\n\")), mdx(\"p\", null, \"The url of the rest API will be displayed in the console output if it's deployed successfully\"), mdx(\"h2\", null, \"Test the deployed stack\"), mdx(\"p\", null, \"Since we provisioned a POST API \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/messages\"), \" to publishing the messages to the queue, you can use any tools to call the API to test publishing messages\\nFor example, I use \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://marketplace.visualstudio.com/items?itemName=rangav.vscode-thunder-client\"\n  }, \"Thunder client\"), \" to make an HTTP request with a JSON body like this\\n\", mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"758px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"66.66666666666666%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXElEQVQ4y6WSTU7DMBCFcwlUNY2dxPbE/01SkCoqVe2CDVfgApyDkz9kh1RUpQLaxdN4PNY3b2wX3nsYYxBjxDAMWX3fI3iP9Xqd87mW8lQbxzHv8bpGwyuUXcTi7QMPr+8orLUQQoCIcnTOoVWEuHmCVATqNOqmAeccdQI0zUkprzkHaxWW4wFl2KKYQQkspYTWGooI2gVoY6YGbZv3U2SMZfiZGENdLlCvliiUUnDeI/YD2tSVczRNm2NqoKTMblLjFH8EJpe8BuMcxezOWJtHFVJAimmc+fC8ziNe0XwFRVqkUZSxWO9f4GPAY6RcnN18j9c0NywyTEp01iE8H2C9w+DVGfA3XQClEBNwNwFHnxzy24GkFMg4xN0xP9AY6HaH6VG6jkDGIuyOk8O7gUQg++UweGzuAbZCQHcdlDbw233+Pr1TZwf/BTz9Ic5RrUpUVYWqYhdf5q/AT3epa4zoGIXjAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"test example\",\n    \"title\": \"test example\",\n    \"src\": \"/static/829417419a95540feb683298dee927e0/c8e86/cdk-test-publish-messages.png\",\n    \"srcSet\": [\"/static/829417419a95540feb683298dee927e0/5a46d/cdk-test-publish-messages.png 300w\", \"/static/829417419a95540feb683298dee927e0/0a47e/cdk-test-publish-messages.png 600w\", \"/static/829417419a95540feb683298dee927e0/c8e86/cdk-test-publish-messages.png 758w\"],\n    \"sizes\": \"(max-width: 758px) 100vw, 758px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n    \")), mdx(\"p\", null, \"You can check the logs and metrics for SNS and SQS on CloudWatch in the AWS console to check the results of the publishing and processing of the messages. If all works correctly, you should be able to see that the messages are processed one by one in sequences in the correct order from the Cloudwatch logs of the Lambda function that process the messages.\\n\", mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"842px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/c9f3c6f0ec5af2d74a22595c4d14001b/99072/messages-logs.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"60%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABl0lEQVQoz12TWZLDMAhEdf9DJl5lW5b3LYlTxdRDViYzHxQgLNR0Y9MPg7Stl3lZ5DgO2ff98of6aOd5yuv1UiM+z+jPPzWTZbkkSSrWVlJaK23bSl03Ute1lKVVIx+GQZZ1lXEcpes6GYZRz/oe62WaZlnXTQxFEHrfSdO4T+yvc85Av66rIt22TeNvW5ZFJ6NmWu/FOSfOtdJ1/eU78d4rWppP06QoyEE0jpP0FzpQkuMfj4cYmjEuI/ACr83zrE0wYs6ez6ei4BJx9NHIPxzmeSFFUSqXTRP4Y9SyLLVGXlW1PgDiWK84h2trdQL4Nfck0UZ5HsThorVWUWd5Lmma6ahcDA29VFUljXPqo5jQpQ1Zj0jotu06XiD6l3TEYKT/I7Mu7/dbLa6OAcXtdtdXIBYEURCnonjlFwFCHEQADY3j/mHkBo7YNS4jEFyEpt1HffLvtYlTsHuIxgPkTGjgDUFAmGaBL5qwg/BDjYZJmipPiFGU4XtqRVFcPHtdN4MIIOGARiAljo1RHTG+f0O4jNxHi7UfutCOg5d9OBkAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"messages logs\",\n    \"title\": \"messages logs\",\n    \"src\": \"/static/c9f3c6f0ec5af2d74a22595c4d14001b/99072/messages-logs.png\",\n    \"srcSet\": [\"/static/c9f3c6f0ec5af2d74a22595c4d14001b/5a46d/messages-logs.png 300w\", \"/static/c9f3c6f0ec5af2d74a22595c4d14001b/0a47e/messages-logs.png 600w\", \"/static/c9f3c6f0ec5af2d74a22595c4d14001b/99072/messages-logs.png 842w\"],\n    \"sizes\": \"(max-width: 842px) 100vw, 842px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"h2\", null, \"Source code of this example\"), mdx(\"p\", null, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/singmak/my-ordered-message-process-service\"\n  }, \"https://github.com/singmak/my-ordered-message-process-service\")));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"6ae4b5f1-5c73-5e1c-a83b-4cdbd3689e7b","slug":"2021-5-16-sqs-fifo-lambda","__params":{"slug":"2021-5-16-sqs-fifo-lambda"}}},"staticQueryHashes":["3159585216"]}