<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" name="viewport" content="initial-scale=1, width=device-width"/><meta name="generator" content="Gatsby 4.5.4"/><style data-href="/styles.6ed856706c4e7f2d4814.css" data-identity="gatsby-global-css">a{color:#1976d2}a:hover{color:#004ba0}</style><style data-emotion="css-global 1mskswx">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:Merriweather,sans-serif;font-weight:400;font-size:1rem;line-height:1.5;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="css 1w3sugh 3v8va9 1qsxih2 8p5sgb 1vo0z3w a9n7s9 k6h796 130f8nx 1n99ejb 11kqkkz vubbuv 66wxz3 he27a0 eud0j5 d404y7 1nevh8s sy1unb">.css-1w3sugh{background-color:#e6f1f3;}.css-3v8va9{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 3px 5px -1px rgba(0,0,0,0.2),0px 5px 8px 0px rgba(0,0,0,0.14),0px 1px 14px 0px rgba(0,0,0,0.12);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:-webkit-sticky;position:sticky;z-index:1100;top:0;left:auto;right:0;background-color:#456679;color:#fff;}.css-1qsxih2{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1qsxih2{padding-left:24px;padding-right:24px;}}@media (min-width:1200px){.css-1qsxih2{max-width:1200px;}}.css-8p5sgb{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;min-height:56px;}@media (min-width:0px) and (orientation: landscape){.css-8p5sgb{min-height:48px;}}@media (min-width:600px){.css-8p5sgb{min-height:64px;}}.css-1vo0z3w{margin:0;font-family:Merriweather,sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;text-transform:uppercase;color:rgba(0, 0, 0, 0.87);-webkit-text-decoration:none;text-decoration:none;margin-right:8px;}.css-a9n7s9{margin-left:auto;margin-right:auto;}.css-k6h796{margin:0;font-family:Merriweather,sans-serif;font-weight:400;font-size:1rem;line-height:1.5;color:#fff;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}@media (min-width:0px){.css-k6h796{display:none;}}@media (min-width:900px){.css-k6h796{display:block;}}@media (min-width:0px){.css-130f8nx{display:none;}}@media (min-width:600px){.css-130f8nx{display:block;}}.css-1n99ejb{margin:0;font-family:Merriweather,sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;text-transform:uppercase;color:rgba(0, 0, 0, 0.87);-webkit-text-decoration:none;text-decoration:none;margin-left:20px;color:#fff;font-family:roboto;padding:5px 7px;background-color:#51748a;text-align:center;}.css-1n99ejb:hover{color:#fff;background-color:#6a889c;}.css-11kqkkz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;sx:block;color:#fff;}.css-11kqkkz::-moz-focus-inner{border-style:none;}.css-11kqkkz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-11kqkkz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-11kqkkz:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-11kqkkz:hover{background-color:transparent;}}.css-11kqkkz.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}@media (min-width:600px){.css-11kqkkz{display:none;}}.css-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.css-66wxz3{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;padding:40px;}@media (min-width:600px){.css-66wxz3{padding-left:24px;padding-right:24px;}}@media (min-width:900px){.css-66wxz3{max-width:900px;}}.css-he27a0{margin:0;font-family:Merriweather,sans-serif;font-weight:400;font-size:1rem;line-height:1.5;}@media (min-width:0px){.css-he27a0{font-size:1.5rem;}}@media (min-width:900px){.css-he27a0{font-size:2.5rem;}}.css-eud0j5{margin:0;font-family:Merriweather,sans-serif;font-weight:400;font-size:1rem;line-height:1.5;}.css-d404y7 img{padding:8px;background:#fff;}.css-1nevh8s{background-color:#bedbda;border-top:1px solid #99c5c2;}.css-sy1unb{margin:0;font-family:Merriweather,sans-serif;font-weight:400;font-size:1rem;line-height:1.5;text-align:left;padding-top:16px;padding-bottom:8px;font-size:12px;}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Sing Mak&#x27;s software engineering journey | Intro: Talking to your database with Hasura</title><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc4.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxK.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmEU9fBBc4.woff2"/><style>@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:300;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc4.woff2) format("woff2")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:400;src:url(/static/webfonts/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxK.woff2) format("woff2")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:500;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmEU9fBBc4.woff2) format("woff2")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:300;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc-.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:400;src:url(/static/webfonts/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxM.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:500;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmEU9fBBc-.woff) format("woff")}</style><link href="https://fonts.googleapis.com/css?family=Merriweather|Source+Sans+Pro:300,400,400i,700&amp;display=swap" rel="stylesheet"/><link as="script" rel="preload" href="/webpack-runtime-e065def72824509bfca3.js"/><link as="script" rel="preload" href="/framework-d8189f7cda955829bf48.js"/><link as="script" rel="preload" href="/app-633a07c25fda03c7ef32.js"/><link as="script" rel="preload" href="/73b95f1a9c56e727b331a5e57d94e41ed649d8db-055f1395ee8521fa4176.js"/><link as="script" rel="preload" href="/component---src-pages-post-mdx-slug-tsx-19f282faa8f72b86108a.js"/><link as="fetch" rel="preload" href="/page-data/post/2021-5-8-turn-express-app-to-lambda-cdk/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3159585216.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="MuiBox-root css-1w3sugh"><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation5 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionSticky css-3v8va9"><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><div class="MuiToolbar-root MuiToolbar-regular css-8p5sgb"><a class="MuiTypography-root MuiTypography-button MuiLink-root MuiLink-underlineNone css-1vo0z3w" href="/"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:136px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;30&#x27; width=&#x27;136&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear"></div><picture><source type="image/webp" data-srcset="/static/7a681c1580bd25ffd0f41f646f3afa64/ccc63/singmak_logo.webp 34w,/static/7a681c1580bd25ffd0f41f646f3afa64/98ae6/singmak_logo.webp 68w,/static/7a681c1580bd25ffd0f41f646f3afa64/f51e6/singmak_logo.webp 136w" sizes="(min-width: 136px) 136px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 136px) 136px, 100vw" decoding="async" loading="lazy" data-src="/static/7a681c1580bd25ffd0f41f646f3afa64/f72f6/singmak_logo.png" data-srcset="/static/7a681c1580bd25ffd0f41f646f3afa64/7c010/singmak_logo.png 34w,/static/7a681c1580bd25ffd0f41f646f3afa64/f2fee/singmak_logo.png 68w,/static/7a681c1580bd25ffd0f41f646f3afa64/f72f6/singmak_logo.png 136w" alt="SING MAK"/></picture><noscript><picture><source type="image/webp" srcSet="/static/7a681c1580bd25ffd0f41f646f3afa64/ccc63/singmak_logo.webp 34w,/static/7a681c1580bd25ffd0f41f646f3afa64/98ae6/singmak_logo.webp 68w,/static/7a681c1580bd25ffd0f41f646f3afa64/f51e6/singmak_logo.webp 136w" sizes="(min-width: 136px) 136px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 136px) 136px, 100vw" decoding="async" loading="lazy" src="/static/7a681c1580bd25ffd0f41f646f3afa64/f72f6/singmak_logo.png" srcSet="/static/7a681c1580bd25ffd0f41f646f3afa64/7c010/singmak_logo.png 34w,/static/7a681c1580bd25ffd0f41f646f3afa64/f2fee/singmak_logo.png 68w,/static/7a681c1580bd25ffd0f41f646f3afa64/f72f6/singmak_logo.png 136w" alt="SING MAK"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div></a><div class="MuiBox-root css-a9n7s9"><h1 class="MuiTypography-root MuiTypography-body1 css-k6h796">Deploy an AWS Lambda function with AWS CDK</h1></div><div class="MuiBox-root css-130f8nx"><a class="MuiTypography-root MuiTypography-button MuiLink-root MuiLink-underlineNone css-1n99ejb" href="/">Blog</a><a class="MuiTypography-root MuiTypography-button MuiLink-root MuiLink-underlineNone css-1n99ejb" href="/about">About</a></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeMedium css-11kqkkz" tabindex="0" type="button"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="MenuOutlinedIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></div></header><div class="MuiContainer-root MuiContainer-maxWidthMd css-66wxz3"><h1 class="MuiTypography-root MuiTypography-body1 css-he27a0">Deploy an AWS Lambda function with AWS CDK</h1><p class="MuiTypography-root MuiTypography-body1 css-eud0j5">May 8, 2021</p><div class="MuiBox-root css-d404y7"><p>There are many ways to create and configure the infrastructures of our applications on AWS, either it&#x27;s with the console, AWS CLI or AWS Cloudformation. With AWS CDK, we can create AWS Cloudformation stacks with the power of programming languages. AWS CDK supports multiple programming languages. In this blog post, I am going to demonstrate how to turn a simple Express app API written in Typescript into an AWS Lambda function with AWS CDK.</p><p>Using AWS Cloudformation is a good way to maintain our infrastructures as code. However, writing a Cloudformation template is not easy. Most of my experience with AWS Cloudformation is with Serverless Framework because when I deploy an AWS Lambda service with Serverless Framework, it deploys the Lambda service as a Cloudformation stack and we don&#x27;t need to write a single line of AWS CloudFormation template. It saves us so much work. What&#x27;s even greater about Serverless Framework is that we can override the generated Cloudformation resources or add additional resources in the stack in the serverless.yml. Outside of Serverless Framework, I mostly just use the AWS console or AWS Cli to manually configure the AWS infrastructure... To be honest I was put off by the huge amount of lines of codes that are required to be written to define a stack in a Cloudformation template and all the template syntax that I need to learn...</p><p>But not anymore! Now I know that there&#x27;s a much easier way to create a Cloudformation stack for developers, which is AWS CDK (AWS Cloud Development Kit). </p><h2>Prerequisite</h2><ul><li>AWS CLI environment setup</li><li>Node.js version 14+</li><li>Knowledge of typescript</li><li>Basic knowledge of AWS Lambda</li><li>Knowledge of AWS Lambda</li></ul><h2>Starting point</h2><p>First of all, please download the example project from <a href="https://github.com/singmak/cdk-express-example">here</a>.
This tutorial will use the codes in the <code>starting-point</code> folder of this repository as a start point.</p><h2>Basic CDK stack setup</h2><p>Now assume that you have already downloaded the codes of the starting point project.</p><p>First of all, we need to install AWS CDK:</p><pre><code class="language-sh">npm install -g aws-cdk
cdk --version
</code></pre><p>Now unzip the downloaded package and go to the <code>starting-point</code> folder of the unzipped package in the shell.</p><p>Create a CDK folder for separating application codes from the CDK stack codes.</p><pre><code class="language-sh">mkdir cdk
cd cdk
</code></pre><p>Initialize AWS CDK stack with TypeScript template</p><pre><code class="language-sh">cdk init app --language typescript
</code></pre><p>Install the dependencies for creating the Lambda function and API Gateway resources in the stack.</p><pre><code class="language-sh">npm i @aws-cdk/aws-apigateway @aws-cdk/aws-lambda
</code></pre><p>The project should look like this at this point</p><p><a href="./images/cdk-express-project-structure.png"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:227px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:219.3832599118943%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAsCAYAAABloJjNAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE3UlEQVRIx51X23bbNhDUh7SxRYIgbgQIkpJ4l2Q7dhLHTpw0aZuHnvQH+v9v04Ol5SankU3nYQXJEpfD2Znd9SJJOIw2EFpDb9dQtQeLGMLffyYW4UVLDeEz2Nc95DoHW04JGUuen5Au4hxGGciNhx5X9Pnwg+cmpYScp9BSQbUeuq8Qn0RgyxgsTp6dlB6ZxTF4WYO7FSW1rzpCmmb6IenzErIETGVIlIXuSpjdBrqrfi5hHDOkqUCmNMz5BrLxiH45RbyMEb5jSTLdkII9GQshNJQyyLRF1q6QbSqkUQqRKggmIJiESKaQUkMKPZ1HYlHXOzT1Fs3VB2z2Nxh/u8Hu6yf0N9fY/f0J45cPGD+/w/DhBvVqRN3sEK6p6+0PY+H9GkWxQbHu4aoOed/C7wb4toXfD/BjD9+1yNsGeb6C9xuEa47FIjx3INNZC5/nGLoB7aZFkRdo1w26usXYD2g2DXiaTryy5GgsDtUJhQmO8daj8CVc7uF9gaIoUZQlfFGSXp/SJAk7FQLO5tD7NezdDrzIEJ1EiGKGKIofYo7AF4cfSSGQWg1ZOXApSH8PTeKbRE8iDC9RxNH3Ebouhjpv4T/sYa865LdbuLcj2XGuwAkhIw45eMKo66TOgBtFZ2rN5Bg2N2FwijaQroJsC5R/vkR+t4e73SJ/v4MoLeLT+OFx5xWFp5BJCuEMROmojYncTEiFeJ6XI5ZgwwWuYwm9csg/nsG9HVB+uSSU/uOebhDa2UwOA38JjJ64DByGKtOpJL1PZujvP4QRh3MMZ2dLiLpE+cdLuOsB7naEOa8ROP62wjM4vEdoGLjRU2Xv44Ay+QGPxxIv4pgjswkuzpfQQYN3O2QXDaHM3+1QfL6g4UXSWU5oD8l+lJQQCpHAWgauFdKgPzvpMCALzhGFBdcTn+F8FGHg0DqG3W4JfdaQ9tzNiOqvV4QyoA26tG96Qhy+Czc75hxCKGWCPL/n0E48BlTEZUCc6YlL/nRhJoQ2xn57ArVvJv9e3+vw7QD3ZqDPcpV/t1Ecc83UYMPEsxXkytEqosLA70qoukCaG4jKIRHfa/EohzSTbYF01SO7bKjTEFfBy3d7mN2a5nRKvLEZToki8GINefkeXKaTO5Sc+mLokdnEa+BvXoNdnoI3W8i7r1C9R3Y7wt4MsLcj3Mc9suse9v2W5DKnJ1KVaa/hnMZA4QsooeCMpZninYe3Oc2cmSOAgUsOk2Xomg5jN6DyFZq6Qd/2GIYR+/0ZsszSxHsyYcolrjZ3UMqCry3kUEL1FXhhwMsMEWNYnkaP2u27hIJLvGt+R+YKmMsG9qKB2a5pjrjXPbiUSNj8XXGRpAJRHvSWQfclrcWh7YdNNj401cMCOscpjAsw1yDNc5izDbKrFiqIui1ploTlMz6NpvcvogctHhV28HFXv4ApFfRuQ0I2++kMbgnNIdxIDyvYq5b8/dhSv0gFR1nEUKWBOauJu3AGdwRxE9qwhO43yF42JPLHHLMQMkFTx9BeQQ0rWoX1/Rl4DEhFkU2PPueRQ/sv7a/QlYG5aKCHCtllSx0m8Jid14T08N/Ck0VJtIX88g9EUyM7P3DVTRyOqwlhaWc1himhVBDjJdLc0cWqLYizwBct731FQ/8Zuw0DOzmhyk0Sif8Xh6rOWUX+Bd5EKJ50XBx0AAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Project structure" title="Project structure" src="/static/de8e36f96975d09197b874cbdd75d463/9b5be/cdk-express-project-structure.png" srcSet="/static/de8e36f96975d09197b874cbdd75d463/9b5be/cdk-express-project-structure.png 227w" sizes="(max-width: 227px) 100vw, 227px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></a></p><h2>Code refactoring</h2><p>Now we need to do a little code refactoring so that the function logic can be separated from the Express config.<br/>
<!-- -->First, open <code>index.ts</code> in the project root folder and copy all the codes in function for <code>/users</code> API</p><pre><code class="language-typescript">app.get(&#x27;/users&#x27;, (req, res) =&gt; {
  // COPY start
  const users = [&#x27;John&#x27;, &#x27;Tom&#x27;, &#x27;Mary&#x27;].map((name, index) =&gt; ({
    id: index,
    name,
  }));
  // COPY end
  res.json(users);
})

</code></pre><p>create <code>users.ts</code> under the project root folder and create the <code>getUsers</code> function there</p><pre><code class="language-typescript">export const getUsers = () =&gt; {
}
</code></pre><p>Now paste the codes that you just copied inside, and add <code>return users;</code> at the end to return the result of the function.</p><pre><code class="language-typescript">export const getUsers = () =&gt; {
  const users = [&#x27;John&#x27;, &#x27;Tom&#x27;, &#x27;Mary&#x27;].map((name, index) =&gt; ({
    id: index,
    name,
  }));
  return users;
}
</code></pre><p>Next, we will create a handler for the Lambda function:</p><ol><li>Create <code>handler.ts</code> in the project base folder.</li><li>Import <code>getUsers</code> from <code>users.ts</code>.</li><li>Add an async function <code>getUsers</code> to <code>handler.ts</code></li><li>Return <code>statusCode</code> and <code>body</code> in the API response. Make sure that body is a <code>string</code>.</li></ol><p>The returning value determines the API response status code and body.</p><pre><code class="language-typescript">import * as users from &#x27;./users&#x27;;

export const getUsers = async () =&gt; {
  const result = users.getUsers();
  return {
    statusCode: 200,
    body: JSON.stringify(result),
  };
}
</code></pre><p>The reason to put the actual logic of the function in <code>users.ts</code> instead of directly putting it in <code>handler.ts</code> is to make it easier for the original express app to also reuse the <code>getUsers</code> function in <code>users.ts</code>.</p><p>So now we can refactor the original <code>index.ts</code> to call <code>getUsers</code> from <code>users.ts</code> in the <code>/users</code> API.</p><pre><code class="language-typescript">import { getUsers } from &#x27;./users&#x27;;

app.get(&#x27;/users&#x27;, (req, res) =&gt; {
  const users = getUsers();
  res.json(users);
})
</code></pre><h2>Add Lambda Function in the stack</h2><p>Now that the codes are ready, we can work on the CDK stack</p><p>Open <code>cdk/lib/cdk-stack.ts</code> and add the codes to create the Lambda function</p><pre><code class="language-typescript">import * as lambda from &#x27;@aws-cdk/aws-lambda&#x27;;
</code></pre><pre><code class="language-typescript">const getUsersHandler = new lambda.Function(this, &quot;GetUsers&quot;, {
  runtime: lambda.Runtime.NODEJS_14_X,
  code: lambda.Code.fromAsset(&quot;../build&quot;), // build output of the handler js
  handler: &quot;handler.getUsers&quot; // handler is the handler js file name, getUsers is the function name
});

</code></pre><p>Create the API Gateway Rest API that can trigger the Lambda function</p><pre><code class="language-typescript">import * as apigateway from &#x27;@aws-cdk/aws-apigateway&#x27;;
</code></pre><pre><code class="language-typescript">// Create the Rest API
    const api = new apigateway.RestApi(this, &quot;UsersApi&quot;, {
      restApiName: &quot;Users Management&quot;,
      description: &quot;API for management of users.&quot;
    });
    // Add the path /users in the API
    const apiResource = api.root.addResource(&quot;users&quot;);
    const getIntegration = new apigateway.LambdaIntegration(getUsersHandler); // linked to the Lambda function here
    apiResource.addMethod(&quot;GET&quot;, getIntegration);
</code></pre><p>So at the end, the stack should look like this:</p><pre><code class="language-typescript">import * as cdk from &#x27;@aws-cdk/core&#x27;;
import * as lambda from &#x27;@aws-cdk/aws-lambda&#x27;;
import * as apigateway from &#x27;@aws-cdk/aws-apigateway&#x27;;

export class CdkStack extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // The code that defines your stack goes here
    const getUsersHandler = new lambda.Function(this, &quot;GetUsers&quot;, {
      runtime: lambda.Runtime.NODEJS_14_X,
      code: lambda.Code.fromAsset(&quot;../build&quot;),
      handler: &quot;handler.getUsers&quot;
    });

    // Create the Rest API
    const api = new apigateway.RestApi(this, &quot;UsersApi&quot;, {
      restApiName: &quot;Users Management&quot;,
      description: &quot;API for management of users.&quot;
    });
    // Add the path /users in the API
    const apiResource = api.root.addResource(&quot;users&quot;);
    const getIntegration = new apigateway.LambdaIntegration(getUsersHandler);
    apiResource.addMethod(&quot;GET&quot;, getIntegration);
  }
}
</code></pre><h2>Build the project</h2><p>Before building the project, we need to exclude <code>cdk</code> folder in the <code>tsconfig.json</code> in the project base folder.</p><p>Since we don&#x27;t want to build CDK stack on our own (will be handled by CDK deploy)</p><pre><code class="language-json">{
  &quot;compilerOptions&quot;: {
    &quot;target&quot;: &quot;es6&quot;,
    &quot;module&quot;: &quot;commonjs&quot;,
    &quot;rootDir&quot;: &quot;./&quot;,
    &quot;outDir&quot;: &quot;./build&quot;,
    &quot;esModuleInterop&quot;: true,
    &quot;strict&quot;: true,
  },
  &quot;exclude&quot;: [&quot;cdk&quot;]
}
</code></pre><p>Now call <code>npm run build</code> in the shell under the project base folder.</p><p>A new folder <code>build</code> should be generated at the project base folder, which contains the <code>handler.js</code> and <code>users.js</code> files.</p><h2>Deploy the CDK stack</h2><p>First, go to the <code>cdk</code> folder</p><pre><code class="language-sh">cd cdk
</code></pre><p>Then, we need to bootstrap the CDK stack, this is for creating the resources required for doing deployment of the CDK stack.</p><pre><code class="language-sh">cdk bootstrap
</code></pre><p>You can preview the generated Cloudformation template with <code>cdk synth</code> but this is not required to deploy the stack.</p><p>Now we can finally deploy our CDK stack to AWS</p><pre><code class="language-sh">cdk deploy
</code></pre><p>You should see a screen similar to this:
<a href="./images/cdk-express-deploy.png"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1200px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:34.66666666666667%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABDklEQVQoz22Q2aocMQxE+/9/Mg8hIWTa7d2y5eWE9twlA1NwKFmGktDx+/qBuf5gHifmPHH2JNaTPiprduZozKHMqYxRN2sOthavWnDkHMkSdoBqQWpEakJaodS8/Ua1fSH17gnalab1PxpHUaGOutP7GIgKMp496Z+1MNf8WsRXx6/8k6sZbLs2Ti2+eY7aKm00xhx7YtXnu/Wbu/7+n3Oy5iLUgKknSSNRA1EjSROpJQ6XHFc2OLHEEjZeHPcgXzyuWIIEVJWufXtrbdddx4d/c7h4B1qiREKJ2GwJJeyQG1fcxksgS95b7vuv9ZbDJ8MV/2LjAxcf+GJI1RHvjeUiiMGXkyAXRctL4Dv9A1AIIa7KX7YSAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="CDK Deploy" title="CDK Deploy" src="/static/b8872bb333e3883c78bfa4304507e792/c1b63/cdk-express-deploy.png" srcSet="/static/b8872bb333e3883c78bfa4304507e792/5a46d/cdk-express-deploy.png 300w,/static/b8872bb333e3883c78bfa4304507e792/0a47e/cdk-express-deploy.png 600w,/static/b8872bb333e3883c78bfa4304507e792/c1b63/cdk-express-deploy.png 1200w,/static/b8872bb333e3883c78bfa4304507e792/85e74/cdk-express-deploy.png 1436w" sizes="(max-width: 1200px) 100vw, 1200px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></a></p><p>input <code>y</code> and enter to continue</p><p>If the deployment is successful, you should see something similar to this:
<a href="./images/cdk-express-deploy-success.png"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:755px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:29.333333333333332%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVQY052Q7UrDMBhGd/93ok6mTBmC96BDYaJMHWtNavPVTtqka3ukmRR/7I8eOCR5w/MQMlmvXknfP9i8bNBCo4VBbjOybYaRBj0oDLnMkVIihCBN02iSJCil2O12DPR9z2T2eMbi+Yrrp0tmD1POl6dxnd6fMF9dcPt2w2I9Z5ncIRKB0gprLc65aFmWVFUVywYmrjXY/UHXWYpRh2ttnJu9pu4q+u4QOsZYyB/of4LdEcdCUyt8W/2K/J/4h6IoKJoGExpsaFA+UISA8SHus9qT+zA6zD7rgPZNvBvOsvZ87dv4wm/W+cuSQ0f71AAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="CDK Deploy Success" title="CDK Deploy Success" src="/static/e054e000455fb69f63381b159d7563b3/cab43/cdk-express-deploy-success.png" srcSet="/static/e054e000455fb69f63381b159d7563b3/5a46d/cdk-express-deploy-success.png 300w,/static/e054e000455fb69f63381b159d7563b3/0a47e/cdk-express-deploy-success.png 600w,/static/e054e000455fb69f63381b159d7563b3/cab43/cdk-express-deploy-success.png 755w" sizes="(max-width: 755px) 100vw, 755px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></a></p><p>If it deploys successfully, you should be able to see that there&#x27;s a new stack &#x27;CdkStack&#x27; in Cloudformation and the new Rest API created in API Gateway, and the GetUsers Lambda function created in the AWS console.</p><p>You can test the deployed API by calling the url displayed in the deployment outputs.</p><p>For my case, the url is <code>https://ultsb1lqc5.execute-api.ap-southeast-1.amazonaws.com/prod/users</code>. <code>/users</code> is the path of the GET API defined in the CDK stack.</p><h2>Local test</h2><p>Since you didn&#x27;t remove the Express app in the project, you can still run <code>npm start</code> in the project for locally testing the API function. Alternatively, you can also test the function by using a testing framework such as <a href="https://jestjs.io/">jest</a>.</p><h2>Clean up</h2><p>Run <code>cdk destroy</code> under the <code>cdk</code> folder to delete the stack or you can delete directly in the AWS Cloutformation console.</p><h2>Summary</h2><p>This blog post is just a glimpse into the power of CDK. Now that you know how it&#x27;s like to create a Cloudformation Stack with CDK, this opens up the door to the possibilities of defining all kinds of AWS infrastructure with the power of programming languages.</p></div></div><div class="MuiBox-root css-1nevh8s"><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><p class="MuiTypography-root MuiTypography-body1 css-sy1unb">© 2022 Sing Mak</p></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/2021-5-8-turn-express-app-to-lambda-cdk/";window.___webpackCompilationHash="76be96c4aabf4d8bd555";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9a282e6bbe6b2b98339c.js"],"app":["/app-633a07c25fda03c7ef32.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-a95993188f5a7562bae7.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-765025e7479f25c04d98.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-572c8df4ee49cf3fea25.js"],"component---src-pages-post-mdx-slug-tsx":["/component---src-pages-post-mdx-slug-tsx-19f282faa8f72b86108a.js"]};/*]]>*/</script><script src="/polyfill-9a282e6bbe6b2b98339c.js" nomodule=""></script><script src="/component---src-pages-post-mdx-slug-tsx-19f282faa8f72b86108a.js" async=""></script><script src="/73b95f1a9c56e727b331a5e57d94e41ed649d8db-055f1395ee8521fa4176.js" async=""></script><script src="/app-633a07c25fda03c7ef32.js" async=""></script><script src="/framework-d8189f7cda955829bf48.js" async=""></script><script src="/webpack-runtime-e065def72824509bfca3.js" async=""></script></body></html>