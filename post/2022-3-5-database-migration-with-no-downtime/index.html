<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="viewport" content="initial-scale=1, width=device-width"/><meta name="generator" content="Gatsby 4.5.4"/><style data-emotion="css-global 0"></style><style data-emotion="css-global 1bd2rq4">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:#fff;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#121212;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#121212;}</style><style data-emotion="css 1moj6oc 1c0cfyw 8p5sgb 7ujez7 9l3uo3 tmhtgk 130f8nx 92zaya 40ewby vubbuv 66wxz3 19h86vr d404y7">.css-1moj6oc{background-color:#121212;color:#fff;-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);background-image:linear-gradient(rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.09));display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:-webkit-sticky;position:sticky;z-index:1100;top:0;left:auto;right:0;}.css-1c0cfyw{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1c0cfyw{padding-left:24px;padding-right:24px;}}@media (min-width:900px){.css-1c0cfyw{max-width:900px;}}.css-8p5sgb{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;min-height:56px;}@media (min-width:0px) and (orientation: landscape){.css-8p5sgb{min-height:48px;}}@media (min-width:600px){.css-8p5sgb{min-height:64px;}}.css-7ujez7{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;color:#fff;-webkit-text-decoration:none;text-decoration:none;}.css-9l3uo3{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}.css-tmhtgk{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;margin-left:auto;margin-right:auto;}@media (min-width:0px){.css-130f8nx{display:none;}}@media (min-width:600px){.css-130f8nx{display:block;}}.css-92zaya{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;color:#fff;-webkit-text-decoration:none;text-decoration:none;margin-left:20px;}.css-40ewby{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:#fff;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;sx:block;}.css-40ewby::-moz-focus-inner{border-style:none;}.css-40ewby.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-40ewby{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-40ewby:hover{background-color:rgba(255, 255, 255, 0.08);}@media (hover: none){.css-40ewby:hover{background-color:transparent;}}.css-40ewby.Mui-disabled{background-color:transparent;color:rgba(255, 255, 255, 0.3);}@media (min-width:600px){.css-40ewby{display:none;}}.css-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.css-66wxz3{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;padding:40px;}@media (min-width:600px){.css-66wxz3{padding-left:24px;padding-right:24px;}}@media (min-width:900px){.css-66wxz3{max-width:900px;}}.css-19h86vr{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:3rem;}.css-d404y7 img{padding:8px;background:#fff;}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true"></title><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc4.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxK.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmEU9fBBc4.woff2"/><style>@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:300;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc4.woff2) format("woff2")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:400;src:url(/static/webfonts/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxK.woff2) format("woff2")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:500;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmEU9fBBc4.woff2) format("woff2")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:300;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmSU5fBBc-.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:400;src:url(/static/webfonts/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxM.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:500;src:url(/static/webfonts/s/roboto/v29/KFOlCnqEu92Fr1MmEU9fBBc-.woff) format("woff")}</style><link as="script" rel="preload" href="/webpack-runtime-af6e5ed6e51a0d0f0567.js"/><link as="script" rel="preload" href="/framework-d8189f7cda955829bf48.js"/><link as="script" rel="preload" href="/app-10fde124dfe442f8b7b9.js"/><link as="script" rel="preload" href="/7fdc34ca3d837c026f97cc8696d9eeac979076fa-46219c6875d111f4d6e7.js"/><link as="script" rel="preload" href="/component---src-pages-post-mdx-slug-tsx-4f0d0d38f7bc11323d2d.js"/><link as="fetch" rel="preload" href="/page-data/post/2022-3-5-database-migration-with-no-downtime/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3159585216.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="MuiBox-root css-0"><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorDefault MuiAppBar-positionSticky css-1moj6oc"><div class="MuiContainer-root MuiContainer-maxWidthMd css-1c0cfyw"><div class="MuiToolbar-root MuiToolbar-regular css-8p5sgb"><a class="MuiTypography-root MuiTypography-button MuiLink-root MuiLink-underlineNone css-7ujez7" href="/"><h1 class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Sing Mak</h1></a><h1 class="MuiTypography-root MuiTypography-body1 css-tmhtgk">Migration of data and database schema with no downtime</h1><div class="MuiBox-root css-130f8nx"><a class="MuiTypography-root MuiTypography-button MuiLink-root MuiLink-underlineNone css-92zaya" href="/">Blog</a></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeMedium css-40ewby" tabindex="0" type="button"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="MenuOutlinedIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></div></header><div class="MuiContainer-root MuiContainer-maxWidthMd css-66wxz3"><h1 class="MuiTypography-root MuiTypography-body1 css-19h86vr">Migration of data and database schema with no downtime</h1><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">March 5, 2022</p><div class="MuiBox-root css-d404y7"><h2>Schema changes</h2><p>To achieve no downtime, we should deploy database schema changes before deploying the new version of the API service. The reason is that if we deploy the new version of the API service first, the APIs that require the new database schema changes will be broken since the new database schema changes are not there yet.</p><p>Therefore, the new version of the database schema should be deployed first and it must be compatible with the existing version of the API in the production environment when the new API version is still not deployed, which means we cannot simply remove or rename any existing tables and columns or change the column data types. We can only do those changes (delete or alter tables, columns, etc) only when we are sure that the tables or the table columns are not referenced anywhere anymore in the API service.</p><h2>Data migration</h2><p>Data migration may be required for different reasons such as infrastructure changes or business logic changes. It can be tricky to achieve no downtime in doing data migration since new data can still be created during the data migration. Therefore, during data migration, we need to handle it at the API codes level so that the new data are also automatically migrated. </p><p>For example, assume that there is an existing API service, which contains APIs that perform CRUD in a database table A. There is also a web application that makes requests to the API service.</p><p>We need to implement a new business flow and it will replace the existing flow. This new business flow requires the data to be structured differently so a new table B is created to meet the requirement of the new data model. A data migration script is written to transform the data in table A into the new structure and store the transformed data in the new Table B. Both the API service and the web application also need to be updated to implement the new business flow.</p><p>How to implement the API in the API services and perform the deployment in such a way that we can achieve no downtime?</p><p>First of all, even if we have deployed a new version of the web application, we cannot be sure that all client browsers will be loading the latest version of the web application since we cannot know when the users&#x27; browsers will load the latest version of the web application. So for a short amount of time, there will be some users who are still interacting with the old version of the web application. Therefore, in addition to adding new APIs for the new business flow, the existing API that is being used to write data to Table A also need to be updated to be able to transform the data and write to the new Table B. Doing it this way, we will only need to run the data migration script once to migrate the existing data.</p><p>After the new version of the API service is deployed, we can run the migration script to migrate the data from Table A to Table B with the new data structure. During this time, the web application is still not updated and it is still making requests to the old API. But since the old API has been updated to also transform and write data to Table B, we don&#x27;t need to worry about missing some data in the new Table B.</p><p>After the data migration script finishes migrating the data, we can safely deploy the latest version of the web application, that is updated for the new business flow, and makes requests to the new API.</p><p>In summary, to achieve no downtime for data migration, I think the deployment order should be like this:</p><ol><li>Apply data schema changes to production database (make sure it&#x27;s backward compatible with current API service)</li><li>Deploy API service (make sure it&#x27;s backward compatible with current web application and also automatically handle data migration for new data)</li><li>Run data migration script to migrate existing data</li><li>Deploy the web application</li></ol><p>After running with the new updated version of the API service for some time and when all users are using the new version of the web application, the old APIs and the old Table A will eventually become obsolete and we can remove them in the next release of the API service.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:559px">
      <a class="gatsby-resp-image-link" href="/static/55c07cee1c308c9cbfaeec488924bd8e/a65ce/data-migration.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:68%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8klEQVQ4y22TW2vbQBCF9f9/Qp/61LcWWmhJoYWkxMRpwKQ4t4bQxrZkW5JlS/JFvsmnfENGFOKFYXe1M2fOzBkFOrLKslRRFJrP543lea7ZbGbvh8NBdV2/sv1+r2A6y3Vz99ssmWQW4ACAAuLg/wOSdLFYNLZcLjWZTBR0rrvq3j7ouR/q/OLKAqIoUpIkStNU/X5fo9HIAOI4tsCqqpRlmZ357uAGeHv/qM9fv+v9xy86a7V1qGtjhMHSGQAOwHq9tjcS8X08Hpvxhk/wtzfQxc+OPnw6Uef6RpvNVmEY2iMsYEsAJcMQEHoFK5jSBvw4G8NZXog+FuXc9rwom1Jg46xWq1XTw91uZ3eW+7BgHhxT2cuCHUxhBhgsWCjqZ9j6mRa9AkRBHLxviDMcDjWdTi3JZrMxdgRvt1vzc7YGuKoqDaKRBuFQixfqOGAEUDr9AwxQyiUhd2dHRQ3gr+6dGJ2HxycThxVGUcOIkaFcb4NXQUIASeaJ8AuYwdPzts5al/rRutT6RS2yOTPfYeui0ApA2QGEqY3N059nnXw71Zu379S+6mi/3ynLpuYEKOBk9j8GEHZGywHxaQDHcao4SZWkmYaj2EYHERyo1+uZIyyZR0RBZf87vN8u4tGxIRtOBCOMK+vzBiB3+oqvC0PSf/DkKoviCRWMAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="data-migration" title="data-migration" src="/static/55c07cee1c308c9cbfaeec488924bd8e/a65ce/data-migration.png" srcSet="/static/55c07cee1c308c9cbfaeec488924bd8e/5a46d/data-migration.png 300w,/static/55c07cee1c308c9cbfaeec488924bd8e/a65ce/data-migration.png 559w" sizes="(max-width: 559px) 100vw, 559px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
  </a>
    </span></p></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/2022-3-5-database-migration-with-no-downtime/";window.___webpackCompilationHash="d729f68c40b7aa2e3065";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9a282e6bbe6b2b98339c.js"],"app":["/app-10fde124dfe442f8b7b9.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-a95993188f5a7562bae7.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-b735bc6ffd2bc0fa6068.js"],"component---src-pages-post-mdx-slug-tsx":["/component---src-pages-post-mdx-slug-tsx-4f0d0d38f7bc11323d2d.js"]};/*]]>*/</script><script src="/polyfill-9a282e6bbe6b2b98339c.js" nomodule=""></script><script src="/component---src-pages-post-mdx-slug-tsx-4f0d0d38f7bc11323d2d.js" async=""></script><script src="/7fdc34ca3d837c026f97cc8696d9eeac979076fa-46219c6875d111f4d6e7.js" async=""></script><script src="/app-10fde124dfe442f8b7b9.js" async=""></script><script src="/framework-d8189f7cda955829bf48.js" async=""></script><script src="/webpack-runtime-af6e5ed6e51a0d0f0567.js" async=""></script></body></html>